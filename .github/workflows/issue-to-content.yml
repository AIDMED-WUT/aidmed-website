name: Issue to Content

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  process-issue:
    name: Process labeled issue
    runs-on: ubuntu-latest
    if: |
      github.event.label.name == 'add-seminar' ||
      github.event.label.name == 'add-publication' ||
      github.event.label.name == 'add-team-member'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate content file from issue
        id: generate
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABEL: ${{ github.event.label.name }}
        run: node scripts/issue-to-content.mjs

      - name: Create branch and commit
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="content/issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"
          git add src/content/
          git diff --staged --quiet || git commit -m "content: add content from issue #${ISSUE_NUMBER}"
          git push origin "$BRANCH"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_LABEL: ${{ github.event.label.name }}
        run: |
          BRANCH="content/issue-${ISSUE_NUMBER}"
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "Add content: ${ISSUE_TITLE}" \
            --body "Auto-generated from issue #${ISSUE_NUMBER}.

          Closes #${ISSUE_NUMBER}

          Label: \`${ISSUE_LABEL}\`

          Please review the generated content file before merging."
