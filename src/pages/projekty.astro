---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCollection, render } from 'astro:content';

const projects = await getCollection('projects');
const pl = projects
  .filter(p => p.data.lang === 'pl')
  .sort((a, b) => a.data.status === b.data.status ? 0 : a.data.status === 'active' ? -1 : 1);

const renderProject = async (project: typeof projects[0]) => {
  const { Content } = await render(project);
  return { project, Content };
};

const rendered = await Promise.all(pl.map(renderProject));
---

<Layout
  title="Projekty â€“ AIDMED | WydziaÅ‚ MiNI PW"
  description="Projekty badawcze realizowane przez grupÄ™ AIDMED."
  lang="pl"
  alternateHref="/en/projects"
  altLang="en"
>
  <Header lang="pl" alternateHref="/en/projects" currentPath={Astro.url.pathname} />

  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 py-10">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-grafitowy mb-2">Projekty</h1>
        <p class="text-gray-600">
          Projekty badawcze realizowane przez grupÄ™ AIDMED.
        </p>
      </header>

      <div class="space-y-4 mb-10">
        {rendered.map(({ project, Content }) => {
          const completed = project.data.status === 'completed';
          return (
            <details class={`group rounded-lg overflow-hidden border ${completed ? 'border-gray-100 bg-surface' : 'border-gray-200'}`}>
              <summary class={`list-none cursor-pointer p-6 transition-colors ${completed ? 'hover:bg-gray-100/60' : 'hover:bg-gray-50'}`}>
                <div class="flex items-start justify-between gap-3 mb-1">
                  <h3 class="text-lg font-semibold text-grafitowy leading-snug">
                    {project.data.title}
                  </h3>
                  <div class="flex items-center gap-2 shrink-0">
                    <span class={`text-xs font-medium px-2.5 py-1 rounded-full ${completed ? 'bg-gray-200 text-gray-600' : 'bg-mietowy/30 text-grafitowy'}`}>
                      {completed ? 'ZakoÅ„czony' : 'Aktywny'}
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </div>
                {project.data.grant_id && (
                  <p class="text-sm font-medium text-gray-400 mt-1">{project.data.grant_id}</p>
                )}
                {project.data.period && (
                  <p class="text-sm text-gray-500 mt-1">ðŸ“… {project.data.period}</p>
                )}
              </summary>
              <div class={`px-6 pb-6 pt-4 prose prose-sm prose-gray max-w-none text-gray-700 border-t [&_p]:mb-4 ${completed ? 'border-gray-200' : 'border-gray-100'}`}>
                <Content />
              </div>
            </details>
          );
        })}
      </div>
    </div>
  </main>

  <Footer lang="pl" />
</Layout>
